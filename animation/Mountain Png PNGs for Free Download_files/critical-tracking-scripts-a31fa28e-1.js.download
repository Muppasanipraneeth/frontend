import{C as v}from"./js-5386754e-1.js";import{getAnalyticsDimensions as g,getPageviewGuid as y,TRACKING_EVENT_NAME as w,findCategoryByElement as T,dataLayerPush as m,getCompleteEventSources as L,deleteCompleteEventSources as h}from"./tracking-39df6e64-1.js";import{aN as C}from"./actions-c6ee89d5-1.js";import{R as I,D as A}from"./helpers-aaf8efb9-1.js";import{e as P}from"./performance-helpers-20b701c9-1.js";import"./_commonjsHelpers-de833af9-1.js";import"./init-user-58d04eb1-1.js";const{gtag:V}=window,D=({schema:i,eventData:t,userStateData:s})=>{setTimeout(()=>{window.snowplow("trackSelfDescribingEvent",{event:{schema:i,data:t},context:s},0)})},O=({category:i,action:t,label:s="",property:e=null,value:n=null,context:o=null})=>{setTimeout(()=>{window.snowplow("trackStructEvent",{category:i,action:t,label:s,property:e,value:n,context:o},0)})},U=({title:i=null,context:t=null,contextCallback:s=null})=>{setTimeout(()=>{window.snowplow("trackPageView",{title:i,context:t,contextCallback:s})},0)},R=({namespace:i,collectorEndpoint:t,config:s={}})=>{window.snowplow("newTracker",i,t,s)},N=({cookieId:i})=>{window.snowplow("setUserIdFromCookie",i)},j=({minimumVisitLength:i,heartbeatDelay:t})=>{window.snowplow("enableActivityTracking",{minimumVisitLength:i,heartbeatDelay:t})},x=()=>{window.snowplow("enableLinkClickTracking")},l={trackSelfDescribingEvent:D,trackStructEvent:O,trackPageView:U,newTracker:R,setUserIdFromCookie:N,enableActivityTracking:j,enableLinkClickTracking:x},q="iglu:com.eezy/user_state/jsonschema/1-0-7",F="iglu:com.eezy/resource_impressions/jsonschema/1-0-0",M="iglu:com.eezy/turbolinks_timing/jsonschema/1-0-0";class B{constructor({collector:t,appId:s}){this.fireResourceImpressionsEvent=()=>{const e=this.getResourceImpressionsData();e.ids.length>0&&l.trackSelfDescribingEvent({schema:F,eventData:e,userStateData:this.getUserState()})},this.isValidTurbolinkVisit=()=>this.turboVisits>=1,this.collectTurboTiming=e=>{if(!this.isValidTurbolinkVisit())return!1;const n={visitDur:e.detail.timing.visitEnd-e.detail.timing.visitStart,reqDur:e.detail.timing.requestEnd-e.detail.timing.requestStart,prevUrl:this.turboPreviousUrl,visitNo:this.turboVisits};return l.trackSelfDescribingEvent({schema:M,eventData:n,userStateData:this.getUserState()}),!0},this.loadListener=e=>{this.trackPageView(),this.fireResourceImpressionsEvent(),this.collectTurboTiming(e)},this.trackEvent=({category:e,action:n,label:o=null,value:a=null,contentType:d=null,errorText:u=null})=>{const c=this.getUserState({errorText:u});l.trackStructEvent({category:e,action:n,label:o,property:d,value:a,context:c})},this.collector=t,this.appId=s,this.turboVisits=0,this.turboPreviousUrl=""}init(){const t={appId:this.appId,discoverRootDomain:!0,eventMethod:"beacon",contexts:{webPage:!0,performanceTiming:!0,gaCookies:!0,geolocation:!1}},s={namespace:"cf",collectorEndpoint:this.collector,config:t};l.newTracker(s),l.setUserIdFromCookie({cookieId:"session_guid"}),l.enableActivityTracking({minimumVisitLength:10,heartbeatDelay:10}),l.enableLinkClickTracking(),window.addEventListener("turbo:visit",()=>{this.turboVisits+=1}),window.addEventListener("turbo:request-start",()=>{this.turboPreviousUrl=window.location.pathname}),window.addEventListener("turbo:load",this.loadListener)}disconnect(){window.removeEventListener("turbo:load",this.loadListener)}getResourceImpressionsData(){const t={ids:[],pros:[],page:0},s=I();return document.querySelectorAll("[data-item-id]").forEach(e=>{const{itemId:n,pro:o}=e.dataset;t.ids.push(parseInt(n,10)),A(o)?t.pros.push(1):t.pros.push(0)}),s?t.page=parseInt(s,10):delete t.page,t}getUserState({includeFlags:t=!1,includeExpandedDataset:s=!1,errorText:e=null}={}){const{bot_score:n,feature_flags:o,ja3_hash:a,js_detect_passed:d,sign_in_type:u,split_test:c,user_auth_id:p,user_status_start:f,user_status_updated:_,verified_bot:b}=g(),[k,S]=c.split(":"),r={pageviewGuid:y(),fingerprint:v.get("apolloFP")};return t&&(r.flags=o),e&&(r.errorText=e),s&&(r.botScore=n,r.ja3Hash=a,r.jsDetectPassed=d,r.signInType=u,r.splitTestName=k,r.splitTestVariant=S,r.statusStart=f,r.statusUpdated=_,r.userAuthId=p,r.verifiedBot=b),[{schema:q,data:r}]}trackPageView(){const t=this.getUserState({includeFlags:!0,includeExpandedDataset:!0});l.trackPageView({context:t})}}const E="turbo:render";class G{constructor(){this.disconnectEvents=()=>{window.removeEventListener("load",this.freshLoadInit),document.removeEventListener(w,this.trackEvent),document.removeEventListener(E,this.pageLoad)},this.sendEvent=(t,s)=>{if(document.body.dataset.env==="test"){const n=v.get("googleEventsSent")||"[]",o=JSON.parse(n);o.push({event_action:t,...s}),v.set("googleEventsSent",JSON.stringify(o),{domain:".example.com"})}P(()=>{V("event",t,{...g(),...s})});const e={category:s.event_category,action:t};Object.hasOwnProperty.call(s,"event_label")&&(e.label=s.event_label),Object.hasOwnProperty.call(s,"value")&&(e.value=s.value),Object.hasOwnProperty.call(s,"content_type")&&(e.contentType=s.content_type),Object.hasOwnProperty.call(s,"error_text")&&(e.errorText=s.error_text),this.snowplowTracker.trackEvent(e)},this.trackEvent=t=>{const{action:s,category:e,label:n,dataLayer:o,...a}=t.detail,d=t.target||document.body,c={event_category:e||T(d),...a};n&&(c.event_label=n),this.sendEvent(s,c),o&&m(o)},this.goFindValue=(t,s)=>{const e=()=>t.find(a=>!!document.querySelector(a)),n=Array.isArray(t)?e():t;return document.querySelector(n).getAttribute(`data-${s}`)},this.processCompleteEvents=()=>{const t=L();if(!t||!Array.isArray(t)){h();return}t.forEach(s=>{const e=JSON.parse(decodeURIComponent(JSON.stringify(s).replace(/\+/g," ")));if(e.valueElementSelector&&e.valueAttribute){const n=this.goFindValue(e.valueElementSelector,e.valueAttribute);e.value=n,delete e.valueElementSelector,delete e.valueAttribute}if(e.dataLayerCompleteAttrs){const n=g();e.dataLayer=e.dataLayer||[],e.dataLayerCompleteAttrs.forEach(o=>{e.dataLayer[o]=n[o]||""}),delete e.dataLayerCompleteAttrs}this.trackEvent({detail:e})}),h()},this.sendPageViewEvent=()=>{const{user_status_start:t,user_status_updated:s,user_plan:e,user_survey:n,split_test:o,test_block:a,feature_flags:d}=g(),{conversionsLabel:u,conversionsContentType:c}=document.body.dataset,p={action:C,page_title:document.title,page_location:window.location.href,page_path:window.location.pathname,user_status_start:t,user_status_updated:s,user_plan:e,user_survey:n,split_test:o,test_block:a,feature_flags:d};u&&(p.label=u),c&&(p.content_type=c),this.trackEvent({detail:p}),m()},this.pageLoad=()=>{this.sendPageViewEvent(),this.processCompleteEvents()},this.initSnowplow=()=>{const{snowplow_collector:t,snowplow_app_id:s}=g();this.snowplowTracker=new B({collector:t,appId:s}),this.snowplowTracker.init()},this.freshLoadInit=()=>this.pageLoad()}init(){this.initSnowplow(),window.addEventListener("load",this.freshLoadInit),document.addEventListener(w,this.trackEvent),document.addEventListener(E,this.pageLoad)}}window.conversionTracker=new G,window.conversionTracker.init();
